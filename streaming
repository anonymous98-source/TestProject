package com.fundsmanager.ui;

import com.fundsmanager.model.Category;
import com.fundsmanager.model.FundAllocation;
import com.fundsmanager.service.FundCalculationService;
import com.fundsmanager.util.DefaultCategories;
import com.fundsmanager.util.ThemeUtil;

import javax.swing.*;
import java.awt.*;
import java.util.List;

public class MainFrame extends JFrame {

    private JTextField incomeField;

    private CategoryTableModel categoryTableModel;
    private ReportTableModel reportTableModel;

    private PieChartPanel pieChartPanel;

    private final FundCalculationService service = new FundCalculationService();

    public MainFrame() {
        setTitle("Funds Management Dashboard");
        setSize(1150, 700);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLayout(new BorderLayout(10, 10));

        add(createHeader(), BorderLayout.NORTH);
        add(createMainContent(), BorderLayout.CENTER);
    }

    // ================= HEADER =================

    private JPanel createHeader() {
        JPanel header = new JPanel(new BorderLayout());
        header.setBorder(BorderFactory.createEmptyBorder(12, 16, 12, 16));

        JLabel title = new JLabel("Funds Management Dashboard");
        title.setFont(new Font("Segoe UI", Font.BOLD, 24));

        JPanel rightControls = new JPanel(new FlowLayout(FlowLayout.RIGHT, 10, 0));

        incomeField = new JTextField(10);
        incomeField.setFont(new Font("Segoe UI", Font.PLAIN, 14));

        JButton generateBtn = new JButton("Generate Report");
        JButton themeBtn = new JButton("ðŸŒ™ Dark Mode");

        generateBtn.addActionListener(e -> generateReport());
        themeBtn.addActionListener(e -> ThemeUtil.toggleTheme(this));

        rightControls.add(new JLabel("Monthly Income:"));
        rightControls.add(incomeField);
        rightControls.add(generateBtn);
        rightControls.add(themeBtn);

        header.add(title, BorderLayout.WEST);
        header.add(rightControls, BorderLayout.EAST);

        return header;
    }

    // ================= MAIN CONTENT =================

    private JSplitPane createMainContent() {

        // ---------- LEFT : CATEGORY MANAGEMENT ----------

        categoryTableModel = new CategoryTableModel(DefaultCategories.load());
        JTable categoryTable = new JTable(categoryTableModel);
        categoryTable.setRowHeight(28);

        JScrollPane categoryScroll = new JScrollPane(categoryTable);
        categoryScroll.setBorder(BorderFactory.createTitledBorder("Categories"));

        JButton addCategoryBtn = new JButton("+ Add Category");
        addCategoryBtn.addActionListener(e -> addCategory());

        JPanel leftPanel = new JPanel(new BorderLayout(8, 8));
        leftPanel.setBorder(BorderFactory.createEmptyBorder(8, 8, 8, 8));
        leftPanel.add(categoryScroll, BorderLayout.CENTER);
        leftPanel.add(addCategoryBtn, BorderLayout.SOUTH);

        // ---------- RIGHT : REPORT + CHART ----------

        pieChartPanel = new PieChartPanel();

        reportTableModel = new ReportTableModel();
        JTable reportTable = new JTable(reportTableModel);
        reportTable.setRowHeight(28);

        JScrollPane reportScroll = new JScrollPane(reportTable);
        reportScroll.setBorder(BorderFactory.createTitledBorder("Tabular Report"));

        JSplitPane verticalSplit = new JSplitPane(
                JSplitPane.VERTICAL_SPLIT,
                pieChartPanel,
                reportScroll
        );
        verticalSplit.setDividerLocation(320);
        verticalSplit.setResizeWeight(0.45);

        JPanel rightPanel = new JPanel(new BorderLayout());
        rightPanel.setBorder(BorderFactory.createEmptyBorder(8, 8, 8, 8));
        rightPanel.add(verticalSplit, BorderLayout.CENTER);

        // ---------- MAIN SPLIT ----------

        JSplitPane mainSplit = new JSplitPane(
                JSplitPane.HORIZONTAL_SPLIT,
                leftPanel,
                rightPanel
        );
        mainSplit.setDividerLocation(420);
        mainSplit.setResizeWeight(0.35);

        return mainSplit;
    }

    // ================= ACTIONS =================

    private void addCategory() {
        AddCategoryDialog dialog = new AddCategoryDialog(this);
        dialog.setVisible(true);

        Category category = dialog.getCategory();
        if (category != null) {
            categoryTableModel.getCategories().add(category);
            categoryTableModel.fireTableDataChanged();
        }
    }

    private void generateReport() {

        double income;
        try {
            income = Double.parseDouble(incomeField.getText());
            if (income <= 0) throw new NumberFormatException();
        } catch (Exception e) {
            JOptionPane.showMessageDialog(
                    this,
                    "Please enter a valid monthly income",
                    "Invalid Input",
                    JOptionPane.WARNING_MESSAGE
            );
            return;
        }

        List<Category> categories = categoryTableModel.getCategories();

        if (!service.validatePercentage(categories)) {
            JOptionPane.showMessageDialog(
                    this,
                    "Total category percentage must be exactly 100%",
                    "Validation Error",
                    JOptionPane.ERROR_MESSAGE
            );
            return;
        }

        List<FundAllocation> allocations =
                service.calculate(income, categories);

        reportTableModel.setData(allocations);
        pieChartPanel.updateChart(allocations);
    }
}