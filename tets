flowchart TD

%% ============================
%% Requester
%% ============================
subgraph ReqUser ["ğŸ‘¤ Requester"]
    direction TB
    R_Start(("ğŸ”µ Start"))
    R_CreateReq[/"ğŸ“ Create Request  
(CREATE / EDIT / BLOCK / DELETE)"/]
    R_ViewReq["ğŸ‘ï¸ View Own Request"]
    R_CancelReq["âŒ Cancel Request"]
end

%% ============================
%% System
%% ============================
subgraph Sys ["ğŸ–¥ï¸ System"]
    direction TB
    S_Validate["ğŸ§ª Validate Payload & Permissions"]
    S_PersistReq["ğŸ’¾ Save Request  
Status: ğŸŸ¡ <b style='color:#b58900'>PENDING</b>"]
    S_Notify["ğŸ“£ Notify Approvers"]
    S_CheckApprovePerm["ğŸ” Check Approver Permissions"]
    S_RejectOwn["âš ï¸ Deny If Approver == Requester"]
    
    S_SetApproved["<b>ğŸŸ¢ APPROVED</b>  
âœ”ï¸ Mark Request APPROVED"]:::approved
    S_SetRejected["<b>ğŸ”´ REJECTED</b>  
â›” Mark Request REJECTED"]:::rejected
    S_SetCancelled["<b>âš« CANCELLED</b>  
ğŸš« Mark Request CANCELLED"]:::cancelled
    
    S_ApplyChange["ğŸ”§ Apply Change to User Table"]
    S_NotifyResult["ğŸ“© Notify Requester + Audit Entry"]
end

%% ============================
%% Approver
%% ============================
subgraph AppUser ["ğŸ›¡ï¸ Approver"]
    direction TB
    A_View["ğŸ‘ï¸ View Request"]
    A_Approve["ğŸ‘ Approve Request"]
    A_Reject["ğŸ‘ Reject Request"]
end

%% ============================
%% Database
%% ============================
subgraph DB ["ğŸ—„ï¸ Database"]
    direction TB
    DB_Reqs[(ğŸ“‚ Requests Table)]
    DB_Users[(ğŸ‘¥ Users Table)]
    DB_Approvals[(ğŸ§¾ Approvals Log)]
end

%% ----------------------------
%% Main Flow
%% ----------------------------

R_Start --> R_CreateReq
R_CreateReq --> S_Validate

S_Validate -->|âœ… OK| S_PersistReq
S_Validate -->|âŒ Fail| S_NotifyResult

S_PersistReq --> DB_Reqs
S_PersistReq --> S_Notify
S_Notify --> A_View

%% Viewing / Cancelling
R_CreateReq --> R_ViewReq
R_ViewReq --> A_View

R_CreateReq --> R_CancelReq
R_CancelReq --> S_SetCancelled
S_SetCancelled --> DB_Reqs
S_SetCancelled --> S_NotifyResult

%% Approver Path
A_View --> S_CheckApprovePerm
S_CheckApprovePerm -->|ğŸš« No Permission| S_NotifyResult
S_CheckApprovePerm -->|âœ”ï¸ Allowed| S_RejectOwn

S_RejectOwn -->|âŒ Same User| S_NotifyResult
S_RejectOwn -->|âœ”ï¸ Different User| A_Approve

%% Approve
A_Approve --> S_SetApproved
S_SetApproved --> DB_Approvals
S_SetApproved --> DB_Reqs
S_SetApproved --> S_ApplyChange
S_ApplyChange --> DB_Users
S_ApplyChange --> S_NotifyResult

%% Reject
A_Reject --> S_SetRejected
S_SetRejected --> DB_Approvals
S_SetRejected --> DB_Reqs
S_SetRejected --> S_NotifyResult

%% Notifications
S_NotifyResult --> R_ViewReq
S_NotifyResult --> DB_Approvals

%% ====== Styles ======
classDef approved fill:#c8f7c5,stroke:#2e7d32,stroke-width:2px,color:#1b5e20;
classDef rejected fill:#f7c5c5,stroke:#b71c1c,stroke-width:2px,color:#7f0000;
classDef cancelled fill:#d7d7d7,stroke:#424242,stroke-width:2px,color:#212121;

%% Note
classDef note fill:#fff7c2,stroke:#333,stroke-width:1px;
N1["ğŸ“Œ **Status Colors:**  
ğŸŸ¡ Pending â€” Request created, waiting for approval  
ğŸŸ¢ Approved â€” System applies action to User table  
ğŸ”´ Rejected â€” No changes applied  
âš« Cancelled â€” Request withdrawn by requester  
â— Requester cannot approve their own request"]:::note
DB_Reqs --- N1