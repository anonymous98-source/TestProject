---
config:
  layout: elk
  theme: default
---
flowchart LR
 %% === ROLES / LANES ===
 subgraph MAKER["Maker (1)"]
    direction TB
        M_Create["Create report<br/>(type: automatic / web)"]
  end

 subgraph CHECKER["Checker (9)"]
    direction TB
        C_Receive["Receive for check"]
        C_Sign["Checker Sign"]
        C_Reject["Checker Reject"]
        C_AgreeDisagree["Checker: Agree / Disagree?"]
        C_CreateRW23@{ label: "Create RW 23 <br/>(Checker's certificate)" }
        C_Sign_RW23["Sign RW 23 (Freeze at Checker)"]
  end

 subgraph AUDITOR["Auditor (11)"]
    direction TB
        A_Receive["Receive for audit"]
        A_Sign["Auditor Sign"]
        A_Reject["Auditor Reject"]
        A_CreateRW24@{ label: "Create RW 24 <br/>(Auditor's certificate)" }
        A_Sign_RW24["Sign RW 24 (Freeze at Auditor)"]
  end

 subgraph RO["RO (75)"]
    direction TB
        R_Receive["Receive for RO"]
        R_Approve["RO Approve"]
        R_Reject["RO Reject"]
  end

 subgraph LHO["LHO (50)"]
    direction TB
        LHO_Reject["LHO Reject Frozen Report"]
  end

 subgraph SYS["CRS System"]
    direction TB
        Decide_ReportType{"Report type?"}
        S_HasData["(Auto) Has data?"]
        S_Auditable["Branch auditable?"]
        S_SendToChecker["Send to Checker"]
        S_SendToAuditor["Send to Auditor"]
        S_SendToRO["Send to RO"]
        S_Freeze["Freeze report"]
  end

 subgraph DB["Database / State"]
    direction TB
        STATE_FROZEN["FROZEN"]
  end

 %% === MAIN FLOW ===
    M_Create -- automatic / web --> S_SendToChecker
    S_SendToChecker --> C_Receive

    %% Checker actions
    C_Receive --> C_Sign & C_Reject & C_AgreeDisagree

    C_Reject --> HandleRejectByChecker["Checker rejected → back to Maker"]
    HandleRejectByChecker --> BackToMaker["Return to Maker for update"]
    BackToMaker --> M_Create

    C_AgreeDisagree -- Agree --> BackToMaker
    C_AgreeDisagree -- Disagree --> DecideAfterCheckerDisagree{"Is branch auditable?"}
    DecideAfterCheckerDisagree -- yes --> S_SendToAuditor
    DecideAfterCheckerDisagree -- no --> S_SendToRO

    %% After normal Checker sign (non-RW23)
    C_Sign --> Check_IsRW23{"Is type = RW-23?"}
    Check_IsRW23 -- yes --> C_CreateRW23
    Check_IsRW23 -- no --> Decide_ReportType

    %% RW-23 flow (freezes at Checker)
    C_CreateRW23 --> C_Sign_RW23
    C_Sign_RW23 --> S_Freeze

    %% Type branch after Checker – for BOTH automatic & web
    Decide_ReportType -- automatic --> S_HasData
    Decide_ReportType -- web --> S_Auditable

    S_HasData -- yes --> S_Auditable
    S_HasData -- no --> S_Auditable

    S_Auditable -- yes --> S_SendToAuditor
    S_Auditable -- no --> S_SendToRO

 %% === AUDITOR PATH ===
    S_SendToAuditor --> A_Receive
    A_Receive --> A_Sign & A_Reject

    A_Reject --> HandleRejectByAuditor["Auditor rejected → go to Checker for Agree/Disagree"]
    HandleRejectByAuditor --> S_SendToChecker

    %% After Auditor sign (non-RW24)
    A_Sign --> Check_IsRW24{"Is type = RW-24?"}
    Check_IsRW24 -- yes --> A_CreateRW24
    Check_IsRW24 -- no --> S_SendToRO

    %% RW-24 flow (freezes at Auditor)
    A_CreateRW24 --> A_Sign_RW24
    A_Sign_RW24 --> S_Freeze

 %% === RO PATH ===
    S_SendToRO --> R_Receive
    R_Receive --> R_Approve & R_Reject

    R_Approve --> S_Freeze

    R_Reject --> HandleRejectByRO["RO rejected → go to Checker for Agree/Disagree"]
    HandleRejectByRO --> S_SendToChecker

 %% === FROZEN & LHO ===
    S_Freeze --> STATE_FROZEN
    STATE_FROZEN --> LHO_Reject
    LHO_Reject --> HandleLHOReject["LHO rejected (frozen) → go to Checker for Agree/Disagree"]
    HandleLHOReject --> S_SendToChecker

 %% === STYLES ===
    C_CreateRW23@{ shape: rect }
    A_CreateRW24@{ shape: rect }

    style C_Reject fill:#ffd6d6
    style A_Reject fill:#ffd6d6
    style R_Reject fill:#ffd6d6
    style LHO_Reject fill:#ffd6d6
    style S_Freeze fill:#b7e4c7,stroke:#2e7d32
    style STATE_FROZEN fill:#9fd3c7,stroke:#2e7d32
    style AUDITOR stroke:#D50000
    style CHECKER stroke:#FF6D00
    style MAKER stroke:#FFD600,fill:#FFF9C4
    style RO stroke:#00C853
    style SYS fill:#BBDEFB,stroke:#D50000
    style LHO stroke:#2962FF