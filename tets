flowchart TD
  %% ===== Swimlanes (roles) =====
  subgraph MAKER["Maker"]
    direction TB
    M_Create["Create report\n(type: automatic / web / rw23 / rw24)"]
  end

  subgraph CHECKER["Checker"]
    direction TB
    C_Receive["Receive for check"]
    C_Sign["Checker Sign"]
    C_Reject["Checker Reject"]
    C_AgreeDisagree["Checker: Agree with rejection?"]
  end

  subgraph AUDITOR["Auditor"]
    direction TB
    A_Receive["Receive for audit"]
    A_Sign["Auditor Sign"]
    A_Reject["Auditor Reject"]
  end

  subgraph RO["RO"]
    direction TB
    R_Receive["Receive for RO"]
    R_Approve["RO Approve"]
    R_Reject["RO Reject"]
  end

  subgraph LHO["LHO"]
    direction TB
    LHO_Reject["LHO Reject Frozen Report"]
  end

  subgraph SYS["System"]
    direction TB
    S_Worklist["Worklist submitted?"]
    S_Auditable["Branch auditable?"]
    S_HasData["(auto) Has data?"]
    S_Freeze["Freeze report"]
    S_SendToChecker["Send to Checker"]
    S_SendToAuditor["Send to Auditor"]
    S_SendToRO["Send to RO"]
    S_WorklistWait["Wait until worklist submitted"]
  end

  subgraph DB["Database / State"]
    direction TB
    STATE_FROZEN["FROZEN"]
  end

  %% ===== Start & routing by type =====
  M_Create -->|rw23| S_Worklist
  M_Create -->|rw24| S_Worklist
  M_Create -->|automatic / web| S_SendToChecker

  %% worklist gating for rw23 & rw24
  S_Worklist -->|no| S_WorklistWait
  S_WorklistWait --> S_Worklist
  S_Worklist -->|yes| worklist_passed

  worklist_passed -->|rw23| S_SendToChecker
  worklist_passed -->|rw24| S_SendToAuditor

  %% ===== Checker flow =====
  S_SendToChecker --> C_Receive
  C_Receive --> C_Sign
  C_Receive --> C_Reject

  C_Reject --> HandleRejectByChecker

  %% rw23: freeze immediately at checker level after sign
  C_Sign --> checkType1
  checkType1["Is type = rw23?"] -->|yes| S_Freeze
  checkType1 -->|no| afterChecker

  %% automatic reports: check data & auditable
  afterChecker --> S_HasData
  afterChecker --> S_Auditable

  S_HasData -->|yes| S_Auditable
  S_HasData -->|no| S_SendToAuditor

  S_Auditable -->|yes| S_SendToAuditor
  S_Auditable -->|no| S_SendToRO

  %% ===== Auditor flow =====
  S_SendToAuditor --> A_Receive
  A_Receive --> A_Sign
  A_Receive --> A_Reject

  A_Reject --> HandleRejectByAuditor

  %% rw24: freeze immediately at auditor level after sign
  A_Sign --> checkType2
  checkType2["Is type = rw24?"] -->|yes| S_Freeze
  checkType2 -->|no| afterAuditor

  afterAuditor --> DecisionAfterAuditor
  DecisionAfterAuditor{"Is this automatic and has data & auditable?"}
  DecisionAfterAuditor -->|yes| S_Freeze
  DecisionAfterAuditor -->|no| S_SendToRO

  %% wire afterAuditor into DecisionAfterAuditor
  afterAuditor --> DecisionAfterAuditor

  %% ===== RO flow =====
  S_SendToRO --> R_Receive
  R_Receive --> R_Approve
  R_Receive --> R_Reject

  R_Reject --> HandleRejectByRO
  R_Approve --> S_Freeze

  %% ===== Freeze and LHO =====
  S_Freeze --> STATE_FROZEN
  STATE_FROZEN --> LHO_Reject

  LHO_Reject --> HandleLHOReject

  %% ===== Common reject handling nodes (declare before linking) =====
  HandleRejectByAuditor["Auditor rejected → go to Checker for agree/disagree"]
  HandleRejectByRO["RO rejected → go to Checker for agree/disagree"]
  HandleLHOReject["LHO rejected (frozen) → go to Checker for agree/disagree"]
  HandleRejectByChecker["Checker rejected → back to Maker"]
  BackToMaker["Return to Maker for update"]
  DecideAfterCheckerDisagree["Is branch auditable?"]

  %% ===== Reject flows wiring =====
  A_Reject --> HandleRejectByAuditor
  R_Reject --> HandleRejectByRO
  HandleLHOReject --> S_SendToChecker
  HandleRejectByAuditor --> S_SendToChecker
  HandleRejectByRO --> S_SendToChecker
  HandleRejectByChecker --> BackToMaker

  S_SendToChecker --> C_Receive

  C_Receive --> C_AgreeDisagree
  C_AgreeDisagree -->|Agree| BackToMaker
  C_AgreeDisagree -->|Disagree| DecideAfterCheckerDisagree

  BackToMaker --> M_Create

  DecideAfterCheckerDisagree -->|yes| S_SendToAuditor
  DecideAfterCheckerDisagree -->|no| S_SendToRO

  %% ===== Visual styles =====
  style S_Freeze fill:#b7e4c7,stroke:#2e7d32
  style STATE_FROZEN fill:#9fd3c7,stroke:#2e7d32
  style C_Reject fill:#ffd6d6
  style A_Reject fill:#ffd6d6
  style R_Reject fill:#ffd6d6
  style LHO_Reject fill:#ffd6d6

  %% ===== Note (properly closed) =====
  note right of DecideAfterCheckerDisagree
    - rw23: always freeze at Checker after Checker sign (worklist required)
    - rw24: always freeze at Auditor after Auditor sign (worklist required)
    - Automatic reports: if auditable and has data -> freeze after Auditor; else freeze earlier per rules
  end note