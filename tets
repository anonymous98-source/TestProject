flowchart TD
  %% ===== declare swimlane nodes =====
  subgraph MAKER["Maker"]
    direction TB
    M_Create["Create report\n(type: automatic / web)"]
  end

  subgraph CHECKER["Checker"]
    direction TB
    C_CreateRW23["Create rw23 (Checker's certificate)"]
    C_Receive["Receive for check"]
    C_Sign["Checker Sign"]
    C_Reject["Checker Reject"]
    C_AgreeDisagree["Checker: Agree / Disagree?"]
  end

  subgraph AUDITOR["Auditor"]
    direction TB
    A_CreateRW24["Create rw24 (Auditor's certificate)"]
    A_Receive["Receive for audit"]
    A_Sign["Auditor Sign"]
    A_Reject["Auditor Reject"]
  end

  subgraph RO["RO"]
    direction TB
    R_Receive["Receive for RO"]
    R_Approve["RO Approve"]
    R_Reject["RO Reject"]
  end

  subgraph LHO["LHO"]
    direction TB
    LHO_Reject["LHO Reject Frozen Report"]
  end

  subgraph SYS["System"]
    direction TB
    S_Worklist["Worklist submitted?"]
    S_Auditable["Branch auditable?"]
    S_HasData["(auto) Has data?"]
    S_Freeze["Freeze report"]
    S_SendToChecker["Send to Checker"]
    S_SendToAuditor["Send to Auditor"]
    S_SendToRO["Send to RO"]
    S_Wait["Wait until worklist submitted"]
  end

  subgraph DB["Database / State"]
    direction TB
    STATE_FROZEN["FROZEN"]
  end

  %% ===== Start & routing by type =====
  M_Create -->|automatic / web| S_SendToChecker

  %% rw23 created by Checker (not Maker)
  C_CreateRW23 --> S_Worklist
  S_Worklist -->|no| S_Wait --> S_Worklist
  S_Worklist -->|yes| C_Receive_RW23["rw23 starts at Checker"]
  C_Receive_RW23 --> C_Sign_RW23["Checker Sign rw23"]
  C_Sign_RW23 --> S_Freeze

  %% rw24 created by Auditor (not Maker)
  A_CreateRW24 --> S_Worklist
  S_Worklist -->|no| S_Wait2 --> S_Worklist
  S_Worklist -->|yes| A_Receive_RW24["rw24 starts at Auditor"]
  A_Receive_RW24 --> A_Sign_RW24["Auditor Sign rw24"]
  A_Sign_RW24 --> S_Freeze

  %% worklist gating for other routing (ensure worklist node reused)
  S_SendToChecker --> C_Receive
  C_Receive --> C_Sign
  C_Receive --> C_Reject

  C_Reject --> HandleRejectByChecker

  %% After Checker sign: special-case rw23 handled above; for others decide next
  C_Sign --> Check_IsRW23{"Is type = rw23?"}
  Check_IsRW23 -->|yes| S_Freeze
  Check_IsRW23 -->|no| AfterChecker

  %% automatic reports: check data & auditable
  AfterChecker --> S_HasData
  AfterChecker --> S_Auditable

  S_HasData -->|yes| S_Auditable
  S_HasData -->|no| S_SendToAuditor

  S_Auditable -->|yes| S_SendToAuditor
  S_Auditable -->|no| S_SendToRO

  %% Auditor flow for normal reports
  S_SendToAuditor --> A_Receive
  A_Receive --> A_Sign
  A_Receive --> A_Reject
  A_Reject --> HandleRejectByAuditor

  A_Sign --> Check_IsRW24{"Is type = rw24?"}
  Check_IsRW24 -->|yes| S_Freeze
  Check_IsRW24 -->|no| AfterAuditor

  AfterAuditor --> DecisionAfterAuditor{"Is auto & hasData & auditable?"}
  DecisionAfterAuditor -->|yes| S_Freeze
  DecisionAfterAuditor -->|no| S_SendToRO

  %% RO flow
  S_SendToRO --> R_Receive
  R_Receive --> R_Approve
  R_Receive --> R_Reject

  R_Approve --> S_Freeze
  R_Reject --> HandleRejectByRO

  %% Freeze and LHO
  S_Freeze --> STATE_FROZEN
  STATE_FROZEN --> LHO_Reject
  LHO_Reject --> HandleLHOReject

  %% Common reject handling nodes (declared)
  HandleRejectByAuditor["Auditor rejected → go to Checker for Agree/Disagree"]
  HandleRejectByRO["RO rejected → go to Checker for Agree/Disagree"]
  HandleLHOReject["LHO rejected (frozen) → go to Checker for Agree/Disagree"]
  HandleRejectByChecker["Checker rejected → back to Maker"]
  BackToMaker["Return to Maker for update"]
  DecideAfterCheckerDisagree{"Is branch auditable?"}

  %% Reject flows wiring
  A_Reject --> HandleRejectByAuditor
  R_Reject --> HandleRejectByRO
  HandleLHOReject --> S_SendToChecker
  HandleRejectByAuditor --> S_SendToChecker
  HandleRejectByRO --> S_SendToChecker
  HandleRejectByChecker --> BackToMaker

  S_SendToChecker --> C_Receive

  C_Receive --> C_AgreeDisagree
  C_AgreeDisagree -->|Agree| BackToMaker
  C_AgreeDisagree -->|Disagree| DecideAfterCheckerDisagree

  BackToMaker --> M_Create

  DecideAfterCheckerDisagree -->|yes| S_SendToAuditor
  DecideAfterCheckerDisagree -->|no| S_SendToRO

  %% ===== Visual styles =====
  style S_Freeze fill:#b7e4c7,stroke:#2e7d32
  style STATE_FROZEN fill:#9fd3c7,stroke:#2e7d32
  style C_Reject fill:#ffd6d6
  style A_Reject fill:#ffd6d6
  style R_Reject fill:#ffd6d6
  style LHO_Reject fill:#ffd6d6

  %% ===== Notes =====
  note right of DecideAfterCheckerDisagree
    - Maker does NOT create rw23 or rw24.
    - rw23: created and signed by Checker → freezes at Checker level (worklist required).
    - rw24: created and signed by Auditor → freezes at Auditor level (worklist required).
    - Automatic reports: if auditable and has data → freeze after Auditor; else freeze per rules.
  end note