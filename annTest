import React from "react";
import AnnouncementList from "./children/AnnouncementList";

export default function annluncementdTab() {
  // render this component when the user clicks the menu item
  return <AnnouncementList />;
} 




import React, { useEffect, useState } from "react";
import {
  Box,
  Paper,
  Table,
  TableHead,
  TableRow,
  TableCell,
  TableBody,
  IconButton,
  Typography,
  CircularProgress,
  Tooltip,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button
} from "@mui/material";
import EditIcon from "@mui/icons-material/Edit";
import DeleteIcon from "@mui/icons-material/Delete";
import EditAnnouncementDialog from "./EditAnnouncementDialog";
import { callApi } from "../../hooks/callApi"; // adjust path if your hooks folder differs

export default function AnnouncementList() {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);
  const [editRow, setEditRow] = useState(null);
  const [confirmDelete, setConfirmDelete] = useState(null);

  useEffect(() => {
    fetchRows();
  }, []);

  async function fetchRows() {
    setLoading(true);
    try {
      const res = await callApi({ url: "/api/announcements", method: "get", params: { active: "Y" } });
      const data = res?.data ?? res;
      setRows(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error("fetchRows error", err);
    } finally {
      setLoading(false);
    }
  }

  function handleEdit(row) {
    setEditRow(row);
  }

  async function handleSaveEdit(updated) {
    try {
      await callApi({ url: `/api/announcements/${updated.id}`, method: "put", data: updated });
      setRows(prev => prev.map(r => (r.id === updated.id ? updated : r)));
    } catch (err) {
      console.error("update error", err);
      fetchRows();
    } finally {
      setEditRow(null);
    }
  }

  function requestDelete(row) {
    setConfirmDelete(row);
  }

  async function confirmDeleteNow() {
    if (!confirmDelete) return;
    const id = confirmDelete.id;
    setRows(prev => prev.filter(r => r.id !== id)); // optimistic remove
    setConfirmDelete(null);
    try {
      await callApi({ url: `/api/announcements/${id}`, method: "patch", data: { is_active: "N" } });
    } catch (err) {
      console.error("delete (mark inactive) error", err);
      fetchRows();
    }
  }

  if (loading) return <Box textAlign="center" mt={6}><CircularProgress /></Box>;

  return (
    <Box p={2}>
      <Typography variant="h6" gutterBottom>Announcements</Typography>

      <Paper elevation={1}>
        <Table>
          <TableHead>
            <TableRow>
              <TableCell>Title</TableCell>
              <TableCell>Message</TableCell>
              <TableCell>Severity</TableCell>
              <TableCell align="right">Actions</TableCell>
            </TableRow>
          </TableHead>

          <TableBody>
            {rows.length === 0 && (
              <TableRow>
                <TableCell colSpan={4} align="center">No active announcements</TableCell>
              </TableRow>
            )}

            {rows.map(row => (
              <TableRow key={row.id}>
                <TableCell style={{ width: "20%" }}>{row.title}</TableCell>
                <TableCell style={{ width: "60%", whiteSpace: "pre-wrap" }}>{row.message}</TableCell>
                <TableCell style={{ width: "10%" }}>{row.severity}</TableCell>
                <TableCell align="right">
                  <Tooltip title="Edit">
                    <IconButton size="small" onClick={() => handleEdit(row)}>
                      <EditIcon />
                    </IconButton>
                  </Tooltip>
                  <Tooltip title="Delete (sets Is_Active = 'N')">
                    <IconButton size="small" onClick={() => requestDelete(row)}>
                      <DeleteIcon />
                    </IconButton>
                  </Tooltip>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </Paper>

      {editRow && (
        <EditAnnouncementDialog
          open={Boolean(editRow)}
          record={editRow}
          onClose={() => setEditRow(null)}
          onSave={handleSaveEdit}
        />
      )}

      <Dialog open={Boolean(confirmDelete)} onClose={() => setConfirmDelete(null)}>
        <DialogTitle>Confirm delete</DialogTitle>
        <DialogContent>
          <Typography>
            Delete announcement: <b>{confirmDelete?.title}</b>? This sets <code>Is_Active</code> to 'N'.
          </Typography>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setConfirmDelete(null)}>Cancel</Button>
          <Button color="error" onClick={confirmDeleteNow}>Delete</Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
}




import React, { useState, useEffect } from "react";
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Button,
  MenuItem
} from "@mui/material";

const severityOptions = ["INFO", "WARN", "CRITICAL", "ERROR", "DEBUG"];

export default function EditAnnouncementDialog({ open, record, onClose, onSave }) {
  const [form, setForm] = useState({
    id: record.id,
    title: record.title || "",
    message: record.message || "",
    severity: record.severity || "INFO",
    is_active: record.is_active ?? "Y"
  });
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    setForm({
      id: record.id,
      title: record.title || "",
      message: record.message || "",
      severity: record.severity || "INFO",
      is_active: record.is_active ?? "Y"
    });
  }, [record]);

  function change(e) {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, [name]: value }));
  }

  async function save() {
    setSaving(true);
    try {
      await onSave(form);
    } finally {
      setSaving(false);
    }
  }

  return (
    <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
      <DialogTitle>Edit Announcement</DialogTitle>
      <DialogContent dividers>
        <TextField
          margin="dense"
          label="Title"
          name="title"
          value={form.title}
          onChange={change}
          fullWidth
        />
        <TextField
          margin="dense"
          label="Message"
          name="message"
          value={form.message}
          onChange={change}
          fullWidth
          multiline
          minRows={3}
        />
        <TextField
          margin="dense"
          select
          label="Severity"
          name="severity"
          value={form.severity}
          onChange={change}
          fullWidth
        >
          {severityOptions.map(s => <MenuItem key={s} value={s}>{s}</MenuItem>)}
        </TextField>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose} disabled={saving}>Cancel</Button>
        <Button onClick={save} variant="contained" disabled={saving}>Save</Button>
      </DialogActions>
    </Dialog>
  );
}



