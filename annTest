import React, { useEffect, useState } from "react";
import { Box, Fab } from "@mui/material";
import AddIcon from "@mui/icons-material/Add";
import { DataGrid } from "@mui/x-data-grid";
import EditIcon from "@mui/icons-material/Edit";
import DeleteIcon from "@mui/icons-material/Delete";

import useApi from "../../../hooks/useApi";

import CreateAnnouncementDialog from "./CreateAnnouncementDialog";
import EditAnnouncementDialog from "./EditAnnouncementDialog";

export default function AnnouncementList() {
  const { callApi } = useApi();

  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);

  const [openCreate, setOpenCreate] = useState(false);
  const [editRow, setEditRow] = useState(null);

  const USE_DUMMY = false; // set true for testing without backend

  useEffect(() => {
    USE_DUMMY ? loadDummy() : fetchRows();
  }, []);

  function loadDummy() {
    setRows([
      { id: 1, title: "Server Down", message: "Maintenance", severity: "INFO", is_active: "Y" },
      { id: 2, title: "High CPU", message: "CPU 95%", severity: "CRITICAL", is_active: "Y" }
    ]);
  }

  async function fetchRows() {
    setLoading(true);
    try {
      const res = await callApi({
        url: "/api/announcements",
        method: "get",
        params: { active: "Y" }
      });

      setRows(res?.data ?? res);
    } catch (err) {
      console.error("Error fetching announcements", err);
    }
    setLoading(false);
  }

  async function handleDelete(row) {
    setRows(prev => prev.filter(r => r.id !== row.id));

    if (!USE_DUMMY) {
      await callApi({
        url: `/api/announcements/${row.id}`,
        method: "patch",
        data: { is_active: "N" }
      });
    }
  }

  async function handleCreateSave(payload) {
    if (USE_DUMMY) {
      payload.id = rows.length + 1;
      setRows(prev => [...prev, payload]);
      setOpenCreate(false);
      return;
    }

    await callApi({
      url: "/api/announcements",
      method: "post",
      data: payload
    });

    setOpenCreate(false);
    fetchRows();
  }

  async function handleEditSave(updated) {
    if (USE_DUMMY) {
      setRows(prev => prev.map(r => (r.id === updated.id ? updated : r)));
      setEditRow(null);
      return;
    }

    await callApi({
      url: `/api/announcements/${updated.id}`,
      method: "put",
      data: updated
    });

    setEditRow(null);
    fetchRows();
  }

  const columns = [
    { field: "title", headerName: "Title", flex: 1 },
    { field: "message", headerName: "Message", flex: 2 },
    { field: "severity", headerName: "Severity", width: 120 },

    {
      field: "actions",
      headerName: "Actions",
      width: 150,
      renderCell: (params) => (
        <Box display="flex" gap={1}>
          <EditIcon
            style={{ cursor: "pointer" }}
            onClick={() => setEditRow(params.row)}
          />

          <DeleteIcon
            style={{ cursor: "pointer", color: "red" }}
            onClick={() => handleDelete(params.row)}
          />
        </Box>
      )
    }
  ];

  return (
    <Box p={2} height="80vh">

      <DataGrid
        rows={rows}
        columns={columns}
        loading={loading}
        pageSizeOptions={[5, 10, 20]}
        disableRowSelectionOnClick
      />

      <Fab
        color="primary"
        onClick={() => setOpenCreate(true)}
        style={{ position: "fixed", bottom: 30, right: 30 }}
      >
        <AddIcon />
      </Fab>

      <CreateAnnouncementDialog
        open={openCreate}
        onClose={() => setOpenCreate(false)}
        onSave={handleCreateSave}
      />

      {editRow && (
        <EditAnnouncementDialog
          open={Boolean(editRow)}
          record={editRow}
          onClose={() => setEditRow(null)}
          onSave={handleEditSave}
        />
      )}
    </Box>
  );
}





import React, { useState, useEffect } from "react";
import {
  Dialog, DialogTitle, DialogContent, DialogActions,
  TextField, Button, MenuItem, Select, InputLabel,
  FormControl, Chip, Box
} from "@mui/material";

import useApi from "../../../hooks/useApi";

import { LocalizationProvider } from "@mui/x-date-pickers/LocalizationProvider";
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import { DatePicker } from "@mui/x-date-pickers/DatePicker";

export default function CreateAnnouncementDialog({ open, onClose, onSave }) {
  const { callApi } = useApi();

  const initialForm = {
    title: "",
    message: "",
    severity: "INFO",
    target_roles: [],
    start_date: null,
    expiry_date: null
  };

  const [form, setForm] = useState(initialForm);
  const [roles, setRoles] = useState([]);

  useEffect(() => {
    if (open) fetchRoles();
    else setForm(initialForm);
  }, [open]);

  async function fetchRoles() {
    try {
      const res = await callApi({
        url: "/api/roles",
        method: "get"
      });
      setRoles(res?.data ?? res);
    } catch (err) {
      console.error("Error fetching roles", err);
    }
  }

  function changeText(e) {
    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  }

  function handleSave() {
    const payload = {
      ...form,
      start_date: form.start_date?.format("YYYY-MM-DD"),
      expiry_date: form.expiry_date?.format("YYYY-MM-DD"),
      is_active: "Y"
    };

    onSave(payload);
  }

  return (
    <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
      <DialogTitle>Create Announcement</DialogTitle>

      <DialogContent dividers>

        <TextField
          margin="dense"
          label="Title"
          name="title"
          fullWidth
          value={form.title}
          onChange={changeText}
        />

        <TextField
          margin="dense"
          label="Message"
          name="message"
          fullWidth
          multiline
          minRows={3}
          value={form.message}
          onChange={changeText}
        />

        <TextField
          select
          margin="dense"
          fullWidth
          label="Severity"
          name="severity"
          value={form.severity}
          onChange={changeText}
        >
          <MenuItem value="INFO">INFO</MenuItem>
          <MenuItem value="WARN">WARN</MenuItem>
          <MenuItem value="CRITICAL">CRITICAL</MenuItem>
        </TextField>

        {/* MULTI ROLE DROPDOWN */}
        <FormControl fullWidth margin="dense">
          <InputLabel>Target Roles</InputLabel>
          <Select
            multiple
            label="Target Roles"
            name="target_roles"
            value={form.target_roles}
            onChange={(e) =>
              setForm(prev => ({ ...prev, target_roles: e.target.value }))
            }
            renderValue={(selected) => (
              <Box sx={{ display: "flex", flexWrap: "wrap", gap: 0.5 }}>
                {selected.map(val => (
                  <Chip key={val} label={roles.find(r => r.id === val)?.name} />
                ))}
              </Box>
            )}
          >
            {roles.map(role => (
              <MenuItem key={role.id} value={role.id}>
                {role.name}
              </MenuItem>
            ))}
          </Select>
        </FormControl>

        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <DatePicker
            label="Start Date"
            value={form.start_date}
            onChange={(v) => setForm(prev => ({ ...prev, start_date: v }))}
            slotProps={{ textField: { fullWidth: true, margin: "dense" } }}
          />

          <DatePicker
            label="Expiry Date"
            value={form.expiry_date}
            onChange={(v) => setForm(prev => ({ ...prev, expiry_date: v }))}
            slotProps={{ textField: { fullWidth: true, margin: "dense" } }}
          />
        </LocalizationProvider>

      </DialogContent>

      <DialogActions>
        <Button onClick={onClose}>Cancel</Button>
        <Button variant="contained" onClick={handleSave}>Save</Button>
      </DialogActions>
    </Dialog>
  );
} 


import React, { useState, useEffect } from "react";
import {
  Dialog, DialogTitle, DialogContent, DialogActions,
  TextField, Button, MenuItem
} from "@mui/material";

export default function EditAnnouncementDialog({ open, record, onClose, onSave }) {
  const [form, setForm] = useState(record);

  useEffect(() => setForm(record), [record]);

  function change(e) {
    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  }

  function handleSave() {
    onSave(form);
  }

  return (
    <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
      <DialogTitle>Edit Announcement</DialogTitle>

      <DialogContent dividers>

        <TextField
          margin="dense"
          label="Title"
          fullWidth
          name="title"
          value={form.title}
          onChange={change}
        />

        <TextField
          margin="dense"
          label="Message"
          fullWidth
          multiline
          minRows={3}
          name="message"
          value={form.message}
          onChange={change}
        />

        <TextField
          select
          margin="dense"
          fullWidth
          label="Severity"
          name="severity"
          value={form.severity}
          onChange={change}
        >
          <MenuItem value="INFO">INFO</MenuItem>
          <MenuItem value="WARN">WARN</MenuItem>
          <MenuItem value="CRITICAL">CRITICAL</MenuItem>
        </TextField>

      </DialogContent>

      <DialogActions>
        <Button onClick={onClose}>Cancel</Button>
        <Button variant="contained" onClick={handleSave}>Save</Button>
      </DialogActions>
    </Dialog>
  );
}
