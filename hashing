package com.kpmg.filehash.ui;

import com.formdev.flatlaf.FlatDarkLaf;
import com.formdev.flatlaf.FlatLightLaf;
import com.formdev.flatlaf.FlatLaf;
import com.formdev.flatlaf.FlatClientProperties;
import com.formdev.flatlaf.intellijthemes.FlatDraculaIJTheme;
import com.kpmg.filehash.constants.HashAlgorithm;
import com.kpmg.filehash.service.HashService;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import java.awt.*;
import java.awt.datatransfer.StringSelection;
import java.io.File;
import java.util.Objects;
import java.util.prefs.Preferences;

public class FileHashGenerator extends JFrame {

    private static final Preferences PREFS =
            Preferences.userNodeForPackage(FileHashGenerator.class);

    private static final String PREF_THEME = "ui.theme";

    static boolean isDark = UIManager.getLookAndFeel().getName().toLowerCase().contains("dark");

    private enum Theme {
        SYSTEM, LIGHT, DARK, DRACULA
    }


    static {
        try {
            String theme = PREFS.get(PREF_THEME, Theme.SYSTEM.name());

            switch (Theme.valueOf(theme)) {
                case LIGHT -> FlatLightLaf.setup();
                case DARK -> FlatDarkLaf.setup();
                case DRACULA -> FlatDraculaIJTheme.setup();
                case SYSTEM -> {
                    if (isDark)
                        FlatDarkLaf.setup();
                    else
                        FlatLightLaf.setup();
                }
            }

            UIManager.put("TitlePane.useWindowDecorations", true);
            UIManager.put("TitlePane.height", 42);
            UIManager.put("TitlePane.height", 42);
            UIManager.put("Component.arc", 12);
            UIManager.put("Button.arc", 12);
            UIManager.put("TextComponent.arc", 10);
            UIManager.put("ProgressBar.arc", 10);

        } catch (Exception e) {
            System.err.println("Failed to initialize Look & Feel");
        }
    }


    private JTextField fileField;
    private JComboBox<HashAlgorithm> algoBox;
    private JTextArea resultArea;
    private JProgressBar progressBar;
    private File selectedFile;


    public FileHashGenerator() {
        setTitle("File Hash Generator");
        setSize(960, 540);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setupTitleBar();
        setResizable(false);
        Image appIcon = Toolkit.getDefaultToolkit().getImage(getClass().getResource("/slack.png"));
        setIconImage(appIcon);
        try {
            if (Taskbar.isTaskbarSupported()) {
                Taskbar.getTaskbar().setIconImage(appIcon);
            }
        } catch (Exception ignored) {
        }
        initUI();
    }


    private void setupTitleBar() {
        getRootPane().putClientProperty(
                FlatClientProperties.TITLE_BAR_BACKGROUND,
                new Color[]{
                        new Color(98, 0, 234),   // Gradient start
                        new Color(55, 0, 179)    // Gradient end
                }
        );

        getRootPane().putClientProperty(
                FlatClientProperties.TITLE_BAR_FOREGROUND,
                Color.WHITE
        );


    }


    private void initUI() {
        JPanel root = new JPanel(new BorderLayout(15, 15));
        root.setBorder(new EmptyBorder(15, 15, 15, 15));
        setContentPane(root);
        Dimension staticDimension = new Dimension(120, 32);


        JPanel filePanel = new JPanel(new BorderLayout(10, 10));
        filePanel.setPreferredSize(staticDimension);
        fileField = new JTextField();
        fileField.setEditable(false);

        JButton browseBtn = new JButton("Browse");
        browseBtn.setPreferredSize(staticDimension);
        browseBtn.addActionListener(e -> chooseFile());

        filePanel.add(fileField, BorderLayout.CENTER);
        filePanel.add(browseBtn, BorderLayout.EAST);
        root.add(filePanel, BorderLayout.NORTH);


        JPanel centerPanel = new JPanel();
        centerPanel.setLayout(new BoxLayout(centerPanel, BoxLayout.Y_AXIS));

        JPanel algoPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 15, 5));
        algoBox = new JComboBox<>(HashAlgorithm.values());
        algoBox.setPreferredSize(staticDimension);

        JButton generateBtn = new JButton("Generate Hash");
        generateBtn.setPreferredSize(staticDimension);
        generateBtn.addActionListener(e -> generateHash());

        algoPanel.add(new JLabel("Algorithm:"));
        algoPanel.add(algoBox);
        algoPanel.add(generateBtn);

        centerPanel.add(algoPanel);
        centerPanel.add(Box.createVerticalStrut(10));

        resultArea = new JTextArea(4, 40);
        resultArea.setEditable(false);
        resultArea.setLineWrap(true);
        resultArea.setWrapStyleWord(true);
        resultArea.setFont(new Font("JetBrains Mono", Font.PLAIN, 13));

        JScrollPane resultScroll = new JScrollPane(resultArea);
        resultScroll.setBorder(
                BorderFactory.createTitledBorder("Result Hash")
        );

        centerPanel.add(resultScroll);
        centerPanel.add(Box.createVerticalStrut(15));

        progressBar = new JProgressBar(0, 100);
        progressBar.setStringPainted(true);
        centerPanel.add(progressBar);

        root.add(centerPanel, BorderLayout.CENTER);


        JPanel bottomPanel = new JPanel(new BorderLayout(10, 10));

        JButton copyBtn = new JButton("Copy to Clipboard");
        copyBtn.setPreferredSize(staticDimension);
        copyBtn.addActionListener(e -> copyHash());

        JComboBox<Theme> themeSelector = new JComboBox<>(Theme.values());
        themeSelector.setPreferredSize(staticDimension);
        themeSelector.setSelectedItem(
                Theme.valueOf(PREFS.get(PREF_THEME, Theme.SYSTEM.name()))
        );
        themeSelector.addActionListener(e ->
                switchTheme((Theme) themeSelector.getSelectedItem())
        );

        JPanel leftPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 10, 0));
        leftPanel.add(copyBtn);
        leftPanel.add(new JLabel("Theme:"));
        leftPanel.add(themeSelector);

        JLabel footer = new JLabel("Â© rugved.dev");
        footer.setForeground(Color.GRAY);

        bottomPanel.add(leftPanel, BorderLayout.WEST);
        bottomPanel.add(footer, BorderLayout.EAST);

        root.add(bottomPanel, BorderLayout.SOUTH);
    }

    private void switchTheme(Theme theme) {
        try {
            PREFS.put(PREF_THEME, theme.name());

            switch (theme) {
                case LIGHT -> FlatLightLaf.setup();
                case DARK -> FlatDarkLaf.setup();
                case DRACULA -> FlatDraculaIJTheme.setup();
                case SYSTEM -> {
                    if (isDark)
                        FlatDarkLaf.setup();
                    else
                        FlatLightLaf.setup();
                }
            }

            FlatLaf.updateUI();
            SwingUtilities.updateComponentTreeUI(this);

        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Theme switch failed");
        }
    }


    private void chooseFile() {
        JFileChooser chooser = new JFileChooser();
        if (chooser.showOpenDialog(this) == JFileChooser.APPROVE_OPTION) {
            selectedFile = chooser.getSelectedFile();
            fileField.setText(selectedFile.getAbsolutePath());
        }
    }

    private void generateHash() {
        if (selectedFile == null) {
            JOptionPane.showMessageDialog(this, "Please select a file.");
            return;
        }

        resultArea.setText("");
        progressBar.setValue(0);

        SwingWorker<String, Integer> worker = new SwingWorker<>() {
            @Override
            protected String doInBackground() throws Exception {
                return HashService.generateHash(
                        selectedFile,
                        ((HashAlgorithm) Objects.requireNonNull(algoBox.getSelectedItem())).getAlgorithm(),
                        this::setProgress
                );
            }

            @Override
            protected void done() {
                try {
                    resultArea.setText(algoBox.getSelectedItem() + " : " + get());
                } catch (Exception e) {
                    JOptionPane.showMessageDialog(
                            FileHashGenerator.this,
                            "Error: " + e.getMessage()
                    );
                }
            }
        };

        worker.addPropertyChangeListener(evt -> {
            if ("progress".equals(evt.getPropertyName())) {
                progressBar.setValue((Integer) evt.getNewValue());
            }
        });

        worker.execute();
    }

    private void copyHash() {
        if (!resultArea.getText().isEmpty()) {
            Toolkit.getDefaultToolkit()
                    .getSystemClipboard()
                    .setContents(
                            new StringSelection(resultArea.getText()),
                            null
                    );
        }
    }


    public static void main(String[] args) {
        SwingUtilities.invokeLater(() ->
                new FileHashGenerator().setVisible(true)
        );
    }
}
