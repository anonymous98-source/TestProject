const [tempYearInput, setTempYearInput] = useState("");
const [selectedYear, setSelectedYear] = useState(null);
const pickerRef = useRef(null);

// derive allowed range
const minYear = nextFYInfo?.expectedStart?.year() ?? null;
const maxYear = minYear; // your rule currently fixes FY to exactly one year

// computed error + message
const yearNum = Number(tempYearInput);
const isComplete = tempYearInput.length === 4;
const isOutOfRange =
  isComplete && (yearNum < minYear || yearNum > maxYear);

// dynamic message
const helperMsg = (() => {
  if (!isComplete) return "";
  if (isOutOfRange) return `Allowed year: ${minYear}`;
  return `Selected Financial Year: ${yearNum}-${yearNum + 1}`;
})();

return (
  <LocalizationProvider dateAdapter={AdapterDayjs}>
    <DatePicker
      ref={pickerRef}
      views={["year"]}
      label="Financial Year*"
      value={selectedYear ? dayjs(`${selectedYear}-01-01`) : null}
      minDate={minYear ? dayjs(`${minYear}-01-01`) : undefined}
      maxDate={maxYear ? dayjs(`${maxYear}-12-31`) : undefined}
      onChange={(val) => {
        if (!val) return;
        const y = val.year();
        if (y >= minYear && y <= maxYear) {
          setSelectedYear(y);
          setTempYearInput(String(y));
        }
      }}
      slotProps={{
        textField: {
          value: tempYearInput,
          onChange: (e) => {
            let raw = e.target.value.replace(/\D/g, "");
            if (raw.length > 4) raw = raw.slice(0, 4); // auto-format cap @ 4 digits
            setTempYearInput(raw);

            if (raw.length === 4) {
              const y = Number(raw);

              // auto open picker after 4 digits
              if (pickerRef.current) {
                pickerRef.current.openPicker();
              }

              // range check
              if (y >= minYear && y <= maxYear) {
                setSelectedYear(y);
              }
            }
          },
          size: "small",
          fullWidth: true,
          error: isOutOfRange,
          helperText: helperMsg,
          FormHelperTextProps: {
            sx: {
              mt: 1,
              fontSize: "0.9rem",
              fontWeight: 500,
              color: isOutOfRange ? "error.main" : "#6500caff",
            },
          },
        },
      }}
    />
  </LocalizationProvider>
);
